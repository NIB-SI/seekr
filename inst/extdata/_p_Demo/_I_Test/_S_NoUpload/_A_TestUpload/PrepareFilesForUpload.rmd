---
title: "Prepare list of files for upload to FAIRDOMHub with seekr"
author: "A. Blejec"
date: "Last compiled on `r format(Sys.time(), '%Y-%m-%d')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
.testing <- TRUE
```


## Introduction

I will organize a batch upload to FAIRDOMHub. For the operation I have prepared the R package `seekr`, available at [GitHub](https://github.com/NIB-SI/seekr). Package operations are based on SEEK API [documentation]{https://fairdomhub.org/api}.

```{r}
library(pisar)
#library(rio)
library(jsonlite)
library(httr)
library(seekr)
```


## Prepare pISA environment

Package `seekr` contains demo pISA-tree project. For this demonstration we can use the demo project. It is assumed, that our working directory is a layer of the pISA project. It is recommended that working directory is an assay, so we will start in an assay that is available in the package `seekr`.

Note: If R is already started in an existing assay, the folowing chunk is not needed, set eval to FALSE.

```{r eval=!TRUE}
if(FALSE){astring <- "_p_Demo/_I_Test/_S_Show/_A_Work-R/"
oldwd <- setwd(system.file("extdata", astring, package="seekr"))
oldwd
dir()
}
```

First wee need to initialize the pISA-tree. Function `pisa` returns information of the Function `pisa` will complain, if the working directory is not a pISA layer.

```{r}
pini <- pisa()
```

For a short orientation, here is the structure of the information about the pISA-tree:

```{r}
str(pini)
```

Information can be extracted from the list with information, e.g. assay name:
```{r}
pini$A$name
```

Many parts are present in dot-variables, for assay we have `.a????`:

```{r}
.aname  # pini$A$name
.aroot  # pini$A$root
.ameta  # pini$A$meta
```

For other layers, shorter dot-variables are set `.s????`, `.i????` and `.p????`. Compare `pini` structure to construct other dot-names:
```{r}
pini$inroot
.inroot
```

## Prepare list of files

The most important task is to prepare the list of files to be uploaded. Typically one will upload files in one investigation, usually with all related branches (studies and assays). The metadata key "Upload to FAIRDOMHub" (Yes/No) controls if the layer (together with all subordinated layers) should be included or ignored by the upload process. In addition,  specific files or paths can be declared as ignored by the upload process.
File `seekignore.txt` in the investigation layer contains file names, directory names or name patterns that are used to filter and exclude the list of files to be uploaded. An example of the seekignore file is here:

```{r}
seekignore <- readLines(file.path(.iroot, "seekignore.txt"))
seekignore
```

To keep the number of files shorter we will add a pattern, excluding files in folder Interactive:

```{r}
seekignore <- c(seekignore, "/Interacitve")
seekignore
```

Lines three and four have slash (/) at the end to ignore directories. Line five and six will prevent upload of batch files and files with specific name (in any directory). One can add other patterns into the seekignore.txt file before running the code below.

Function `skFilesToUpload` will first create a list of files in root directory. Then, it will read the seekignore.txt and extend it with patterns of layers that should not be uploaded according to metadata key "Upload to FAIRDOMHub".
In addition, seekignre list will be appended with the list of empty README.MD files that might clutter the FAIRDOMHub list of files.
Then it will filter it according to declarations in the combined seekignore pattern list.

```{r}
forUpload <- skFilesToUpload( root = pini$I$root, skignore=seekignore)
```

Final list of files for upload is

```{r}
forUpload
```

## Connect with the FAIRDOMHub

The user has to have credentials (username, password and FAIRDOMHub id) for the SEEK supported host (url). Production host for FAIRDOMHub as located at <https://fairdomhub.org>. In this document, we will use the test host, located at <https://testing.sysmo-db.org>.

### Options

Functions of package `seekr` intensively use R options() function that is extended by several wrapper functions (e. g. skSetOption, skGetOption,skOptions, skReset). All relevant information are kept in options() list with typical prefix 'sk.'. In addition to credentials and host url, options keep track of the last objects that were created or used during the upload process. This minimizes the need of explicitly referring to the object ids. To eliminate problems with some incorrectly set options, it is a good practice to reset the options before the start of the upload process.

```{r}
skReset( all=TRUE )
skOptions()
```

### Prepare and set the credentials

User has to set the credential options.

```{r}
skSetOption("url", "https://testing.sysmo-db.org")
# Relace values with your username and password
skSetOption("usr", "<user name>")
skSetOption("pwd", "<password>")
skSetOption("myid", "<id number>")
```

With some hidden code, the options are set to my credentials.

```{r, echo=FALSE}
options(.sk$test)
```
```{r}
skOptions()
```

We can test if the settings are set correctly by finding user's name

```{r}
skFindTitle("people", 368)
skOptions()
```

If you see correct user's name in the title field, the connection is alive and set correctly.

## Set the root directory for uploading

Above we decided to upload files in the Investigation branch on the local computer. This decision has to be set in the options by setting the 'root' option:

```{r}
skSetOption("root", pini$I$root)
```

The Investigation branch should be connected to an existing project on the host. The project is usually set by the creator using the web forms on the host early after the project starts. The creator can add members, institutions, set sharing permissions and license.

For our purpose, we will use an existing project named '\_p_Demo' within a programme 'pISA-tree'. First we change the project name in pisa information list
```{r}
.pname <- "_p_Demo"
pini$p$name <- .pname
.prname <- "pISA-tree"
```

By checking the existence of the programme and project, the seekr options will be set. SEEK snforces unique programme and project names. For other ISA layers uniqness must be checked within the parent levels. pISA-tree layer names are also folder names and therefore unique within the parent layer. This is very important for finding appropriate layer for updates. 

```{r}
skFindId("programme", .prname)
skFindId("project", .pname)
```
The last 'touched' programme and project ids are kept in options
```{r}
print.simple.list(skOptions("id"))
```

# Upload

Communication with the host is logged in the log-file. Let's start a new log-file.

```{r}
skLog("Testing upload", 
    file="FAIRDOM.log", append=FALSE)
```

```{r}
# project already exists
if( skFindTitle("projects", skGetOption("proj"))["title"]!=.pname) {cat("Wrong project name or id. Create project", layers[1],"\n")} else {cat("Project exists:", .pname, "\n")}
```


To enable unique investigation name date and time will be appended to the original investigation name.

```{r}
skUploadFile <- function(file, root = skGetOption("root")){
  uplimit <- 3*10^9
path <- normalizePath(file.path(root,file))
path
sname <- gsub("^.*(_S_[^/]*)/_A.*","\\1",file)
if(sname==file) sname <- "" else sname <- sname
aname <- gsub("^.*/(_A_[^/]*)/.*","\\1",file)
if(aname==file) aname <- "" else aname <- aname
fname <- gsub("^.*/(_[AS]_[^/]*)/(.*)","\\2",file)
.sname <- sname
.aname <- aname
print(c(.sname, .aname, fname))
description <- gsub(".*(_p_)","\\1",dirname(normalizePath(file.path(root,file))))
description <- gsub(paste0("/",dirname(fname)),"",description)
meta <- list(
       Title=paste0("/",fname)
     , Description=description
     )
meta
layers <- skSetLayers(file, root)
skFindId("studies",layers$sname)
skFindId("assays",layers$aname)
## ToDo
#if(toupper(fileType(fname)))
  if(regexpr("METADATA",fname)>0) {
  type <- "documents" } else {type <- "data_files"}
type <- "documents"
s <- skCreate(type, meta, file= file)
if(.testing) print(s)
#
f_size <- file.size(file.path(.iroot,file))
if(!is.na(f_size)){
if(f_size< uplimit) {
cat("Uploading ", fname)
f <- skUpload(s, file)
} else { f <- paste( "Not uploaded, File too large", f_size ,">",  uplimit/10^9,"GB") } } else  { f <-  file
        cat("Length NA, not uploaded: ")
}
print(f)
}
file=dirs[3]
skUploadFile(file)
```


```{r}

invname <- paste(.iname,Sys.time(),sep=" | ")
invname
oldLayers <- list(pname="", iname="", sname="", aname="", sdesc="", adesc="")
ind <- 1:length(forUpload)
nind <- length(ind)
#
for( i in ind ){
file <- forUpload[i]
 cat("|", rep("-",50*i/nind-1),">", rep(" ",50*(nind-i)/nind),"| ", i, "/", nind, "\n", file, "\n", sep="")
layers <- skSetLayers(file)
layers
layers$iname <- invname
# Investigation
if(layers$iname!=oldLayers$iname){
if(!skExists("investigations",layers$iname, "proj",verbose=!TRUE)){
  cat("Create investigation:", layers$iname,"\n")
  skCreate("investigations", .imeta, title=layers$iname)
}
}
# Study
if(layers$sname!=oldLayers$sname){
if(!skExists("studies",layers$sname, "inv",verbose=!TRUE)){
  if(length(layers$sdesc) == 1) meta <- .smeta else meta <- layers$sdesc
  cat("Create study:", layers$sname,"\n")
  skCreate("studies", meta, title=layers$sname)
}
}
# Assay
if(layers$aname!=oldLayers$aname){
if(!skExists("assays",layers$aname, "studies",verbose=!TRUE)) {
  if(length(layers$adesc) == 1) meta <- .ameta else meta <- layers$adesc
   cat("Create assay:", layers$aname,"\n")
  skCreate("assays", meta, title=layers$aname)
}
}
skUploadFile(file)
#cat(rep("-",50),"\n",sep="")
oldLayers <- layers
} 
```

