% -*- TeX:Rnw:UTF-8 -*-
% ----------------------------------------------------------------
% .R knitr file  ************************************************
% ----------------------------------------------------------------
%%



\section{Functions for upload to FAIRDOMHub}

A collection of functions to work with SEEK API.
Communication with FAIRDOMHub is established via package \pkg{httr}.

\subsection{Server location and authentication}


The location of receiving server is expected to be in a global environment and named \code{baseurl}.

Main FAIRDOMHub URL and test site urls:

At the moment two locations are available:\\
 main FAIRDOMHub \url{https://www.fairdomhub.org/} and\\
  testing site \url{https://testing.sysmo-db.org}.
Use options() to declare url, your credentials and pISA-tree identifcations (see help for function ?skOptions).

%% <<skIni, purl=FALSE>>=
%% #' Initialize FAIRDOMhub information
%% #'
%% #' Define FAIRDOMhub url and user data
%% #'
%% #' @param url SEEK based server address. It can also be a list with
%% #'   four components interpreted as url, usr, pwd and myid.
%% #' @param usr user name.
%% #' @param pwd password.
%% #' @param myid numeric user id.
%% #' @param prid programme number.
%% #' @param pid project number.
%% #' @param iid investigation number.
%% #' @param sid study number.
%% #' @param aid assay number.
%% #' @return A list with URL and user information. For side effect see Notes.
%% #' @note The returned list is added to the
%% #'      \code{options()} list under name 'seekr'.
%% #' @note At the moment two locations are available: main FAIRDOMHub
%% #'       (https://www.fairdomhub.org/) and testing site
%% #'       (https://testing.sysmo-db.org).
%% #' @export
%% #' @keywords file
%% #' @author Andrej Blejec \email{andrej.blejec@nib.si}
%% #' @examples
%% #' \dontrun{
%% #' options(sk.url="https://www.fairdomhub.org/", sk.usr="username"
%% #'    , sk.pwd="secret", sk.myid=888)
%% #' skOptions()
%% #' #
%% #' fh <- list(sk.url="https://a.new.one", sk.usr="username"
%% #'    , sk.pwd="secret", sk.myid=999)
%% #' options(fh)
%% #' skOptions(hide=NULL)
%% #' }
%% skIni <- function(url="https://www.fairdomhub.org/"
%%     , usr = NULL
%%     , pwd = NULL
%%     , myid = NULL
%%     , prid = NULL
%%     , pid = NULL
%%     , iid = NULL
%%     , sid = NULL
%%     , aid = NULL
%%     ){
%%     if(is.list(url)) {
%%       tmp <- url
%%       url <- tmp[1]
%%       usr <- tmp[2]
%%       pwd <- tmp[3]
%%       myid <- tmp[4]
%%       }
%% #
%% tmp <- list(baseurl = url
%%    , usr = usr
%%    , pwd = pwd
%%    , myid = as.character(myid)
%%    , prid = as.character(prid)
%%    , pid = as.character(pid)
%%    , iid = as.character(iid)
%%    , sid = as.character(sid)
%%    , aid = as.character(aid)
%%    )
%%    options(seekr = tmp)
%% invisible(tmp)
%% }
%% @

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Show all seekr related options}
\hlcom{#'}
\hlcom{#' Lists selected seekr related options that are set in via}
\hlcom{#' the options function. Selection is based on the start}
\hlcom{#' and end of the name. All seekr options start with prefix 'sk.'.}
\hlcom{#' Argument \textbackslash{}code\{end\} give the required sufix for the option to be listed.}
\hlcom{#' Typical use would be to list identifiers, when \textbackslash{}code\{end = "id"\}.}
\hlcom{#' @param end character string defining the end of the string. By default}
\hlcom{#'    all names are valid (empty string).}
\hlcom{#' @param start character string defining the start of the name,}
\hlcom{#'    default is "sk.", which is typical for seekr options.}
\hlcom{#' @param hide vector of names, that should not be listed.}
\hlcom{#'    Default is "sk.pwd" which prevents password to be revealed.}
\hlcom{#' @return A list of seekr related options.}
\hlcom{#' @note At the moment two locations are available: main FAIRDOMHub}
\hlcom{#'       (https://www.fairdomhub.org/) and testing site}
\hlcom{#'       (https://testing.sysmo-db.org).}
\hlcom{#' @note Function options() is used to store server location,}
\hlcom{#'        user credentials and pISA layer identifications.}
\hlcom{#'        Options that can be declared:}
\hlcom{#'          sk.url (server location),}
\hlcom{#'          sk.usr (username),}
\hlcom{#'          sk.pwd (password),}
\hlcom{#'          sk.myid (user id on server),}
\hlcom{#'          sk.instid (user's institution id),}
\hlcom{#'          sk.prid (program id),}
\hlcom{#'          sk.pid (project id),}
\hlcom{#'          sk.iid (investigation id),}
\hlcom{#'          sk.sid (study id),}
\hlcom{#'          sk.aid (assay id).}
\hlcom{#'}
\hlcom{#' @export}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{startsWith\}, \textbackslash{}link\{endsWith\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' options(sk.myid=368)}
\hlcom{#' skOptions()}
\hlcom{#' skOptions("id")}
\hlcom{#' skOptions(hide=NULL)}
\hlcom{#' \}}
\hlstd{skOptions} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{end}\hlstd{=}\hlstr{""}\hlstd{,} \hlkwc{start}\hlstd{=}\hlstr{"sk."}\hlstd{,} \hlkwc{hide}\hlstd{=}\hlstr{"sk.pwd"}\hlstd{)\{}
    \hlstd{sfilter} \hlkwb{<-} \hlkwd{startsWith}\hlstd{(}\hlkwd{names}\hlstd{(}\hlkwd{options}\hlstd{()),start)}
    \hlstd{efilter} \hlkwb{<-} \hlkwd{endsWith}\hlstd{(}\hlkwd{names}\hlstd{(}\hlkwd{options}\hlstd{()),end)}
    \hlstd{hidden} \hlkwb{<-} \hlkwd{names}\hlstd{(}\hlkwd{options}\hlstd{())}\hlopt{%in%} \hlstd{hide}
    \hlkwa{if} \hlstd{(}\hlkwd{length}\hlstd{(hide)}\hlopt{>}\hlnum{0} \hlopt{&} \hlstd{end}\hlopt{==}\hlstr{""}\hlstd{)} \hlkwd{cat}\hlstd{(}\hlstr{"Hidden:"}\hlstd{,}\hlkwd{paste}\hlstd{(hide),}\hlstr{"\textbackslash{}n"}\hlstd{)}
    \hlkwd{options}\hlstd{()[sfilter} \hlopt{&} \hlstd{efilter} \hlopt{& !}\hlstd{hidden]}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}



\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Parse the response from SEEK API and convert to a list.}
\hlcom{#'}
\hlcom{#' @param resp response from SEEK API.}
\hlcom{#' @param ... further arguments.}
\hlcom{#' @return An object (list) of class \textbackslash{}code\{seek_api\}.}
\hlcom{#' @export}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{skGet\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' options(.sk$test)}
\hlcom{#' options("sk.myid")}
\hlcom{#' r <- skGet("people",options("sk.myid"))}
\hlcom{#' names(r)}
\hlcom{#' r$response$status_code}
\hlcom{#' status_code(r$response)}
\hlcom{#' names(r$content)}
\hlcom{#' r}
\hlcom{#' r <- skGet("people")}
\hlcom{#' length(r$content)}
\hlcom{#' names(r$content)}
\hlcom{#' r$content[[1]]}
\hlcom{#' names(r)}
\hlcom{#' r}
\hlcom{#' \}}
\hlstd{skParse} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{resp}\hlstd{,} \hlkwc{...}\hlstd{)\{}
    \hlstd{jsn} \hlkwb{<-} \hlstr{"application/json"}
    \hlstd{parsed} \hlkwb{<-} \hlkwd{invisible}\hlstd{(}\hlkwd{content}\hlstd{(resp,}\hlstr{"parsed"}\hlstd{,}\hlkwc{type}\hlstd{=jsn)}\hlopt{$}\hlstd{data)}
    \hlkwa{if}\hlstd{(}\hlkwd{class}\hlstd{(parsed}\hlopt{$}\hlstd{content)} \hlopt{%in%} \hlstr{"raw"}\hlstd{) parsed}\hlopt{$}\hlstd{content} \hlkwb{<-} \hlkwd{rawToChar}\hlstd{(parsed}\hlopt{$}\hlstd{content)}
     \hlkwa{if} \hlstd{(}\hlkwd{http_error}\hlstd{(resp)) \{}
     \hlkwd{stop}\hlstd{(}
      \hlkwd{sprintf}\hlstd{(}
        \hlstr{"SEEK API request failed [%s]\textbackslash{}n%s\textbackslash{}n<%s>"}\hlstd{,}
        \hlkwd{status_code}\hlstd{(resp),}
        \hlstd{resp}\hlopt{$}\hlstd{header}\hlopt{$}\hlstd{status,}
        \hlstr{"https://app.swaggerhub.com/apis/FAIRDOM/SEEK/0.1"}
      \hlstd{),}
      \hlkwc{call.} \hlstd{=} \hlnum{FALSE}
    \hlstd{)}
  \hlstd{\}}
  \hlkwa{if}\hlstd{(}\hlkwd{length}\hlstd{(parsed}\hlopt{$}\hlstd{meta}\hlopt{$}\hlstd{base_url)}\hlopt{!=}\hlnum{1}\hlstd{) url} \hlkwb{<-} \hlstr{""} \hlkwa{else}
  \hlstd{url} \hlkwb{<-} \hlstd{httr}\hlopt{::}\hlkwd{modify_url}\hlstd{(parsed}\hlopt{$}\hlstd{meta}\hlopt{$}\hlstd{base_url,}\hlkwc{path}\hlstd{=parsed}\hlopt{$}\hlstd{links)}
  \hlstd{ret} \hlkwb{<-}    \hlkwd{structure}\hlstd{(}
       \hlkwd{list}\hlstd{(}
          \hlkwc{id} \hlstd{= parsed}\hlopt{$}\hlstd{id}
        \hlstd{,} \hlkwc{path} \hlstd{= parsed}\hlopt{$}\hlstd{links}\hlopt{$}\hlstd{self}
        \hlstd{,} \hlkwc{url} \hlstd{= url}
        \hlstd{,} \hlkwc{status} \hlstd{= resp}\hlopt{$}\hlstd{status_code}
        \hlstd{,} \hlkwc{title} \hlstd{= parsed}\hlopt{$}\hlstd{content}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{title}
        \hlstd{,} \hlkwc{content} \hlstd{= parsed}
        \hlstd{,} \hlkwc{response} \hlstd{= resp}
       \hlstd{),}
       \hlkwc{class} \hlstd{=} \hlstr{"seek_api"}
       \hlstd{)}
  \hlkwd{return}\hlstd{(ret)}

\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Print method for seek_api object}
\hlcom{#'}
\hlcom{#' @param x object of class \textbackslash{}code\{seek_api\}.}
\hlcom{#' @param content If FALSE (default), content is no printed.}
\hlcom{#' @param ... further arguments passed to or from other methods.}
\hlcom{#' @return An object (list) of class \textbackslash{}code\{seek_api\}.}
\hlcom{#' @export}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{skParse\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' options(.sk$test)}
\hlcom{#' options("sk.myid")}
\hlcom{#' r <- skGet("people",options("sk.myid"))}
\hlcom{#' # Print contents}
\hlcom{#' print( r, TRUE)}
\hlcom{#' # Short version, default}
\hlcom{#' r}
\hlcom{#' r$response$status_code}
\hlcom{#' status_code(r$response)}
\hlcom{#' r$status}
\hlcom{#' \}}
\hlcom{#'}
\hlstd{print.seek_api} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{,} \hlkwc{content}\hlstd{=}\hlnum{FALSE}\hlstd{,} \hlkwc{...}\hlstd{)\{}
\hlkwd{cat}\hlstd{(}\hlstr{"Status:"}\hlstd{, x}\hlopt{$}\hlstd{status,} \hlstr{"\textbackslash{}n"}\hlstd{)}
\hlcom{#if(x$response$status==200)}
\hlstd{\{}
\hlstd{pr} \hlkwb{<-} \hlstd{x}\hlopt{$}\hlstd{content}
\hlkwd{cat}\hlstd{(}\hlstr{"Object:"}\hlstd{, x}\hlopt{$}\hlstd{url,}\hlstr{"\textbackslash{}n"}\hlstd{)}
\hlkwd{cat}\hlstd{(}\hlstr{"Path  :"}\hlstd{, x}\hlopt{$}\hlstd{path,}\hlstr{"\textbackslash{}n"}\hlstd{)}
\hlkwd{cat}\hlstd{(}\hlstr{"Title :"}\hlstd{, x}\hlopt{$}\hlstd{content}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{title,} \hlstr{"\textbackslash{}n"}\hlstd{)}
\hlkwa{if}\hlstd{(content) \{}
\hlkwd{cat}\hlstd{(}\hlkwd{rep}\hlstd{(}\hlstr{"-"}\hlstd{,}\hlnum{20}\hlstd{),}\hlstr{"\textbackslash{}n\textbackslash{}n"}\hlstd{)}
 \hlkwd{str}\hlstd{(x}\hlopt{$}\hlstd{content)}
 \hlstd{\}}
\hlkwd{invisible}\hlstd{(x)}
\hlstd{\}}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}




\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Get inormation from repository.}
\hlcom{#'}
\hlcom{#' @param type Type of information (e.g. "person").}
\hlcom{#' @param id Repository id of an item.}
\hlcom{#' @param uri Repository base address (URI).}
\hlcom{#' @param ... further arguments.}
\hlcom{#' @return An object (list) of class \textbackslash{}code\{seek_api\}.}
\hlcom{#' @export}
\hlcom{#' @note Parameter ... is ignored at this time.}
\hlcom{#' @note Touched component id is set in options.}
\hlcom{#' @keywords file}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{get\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' options(.sk$test)}
\hlcom{#' options("sk.myid")}
\hlcom{#' r <- skGet("people",options("sk.myid"))}
\hlcom{#' names(r)}
\hlcom{#' r$response$status_code}
\hlcom{#' status_code(r$response)}
\hlcom{#' r}
\hlcom{#' # Non existent user}
\hlcom{#' skGet("people",0)}
\hlcom{#' \}}
\hlstd{skGet} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{type}\hlstd{,} \hlkwc{id}\hlstd{,}
                   \hlkwc{uri}\hlstd{=}\hlkwd{options}\hlstd{(}\hlstr{"sk.url"}\hlstd{),} \hlkwc{...} \hlstd{)\{}
\hlcom{#                  uri="https://www.fairdomhub.org", ... )\{}

  \hlkwa{if}\hlstd{(}\hlkwd{missing}\hlstd{(type))} \hlkwd{stop}\hlstd{(}\hlstr{'Argument "type" is missing, with no default'}\hlstd{)}
  \hlkwa{if}\hlstd{(}\hlopt{!}\hlkwd{missing}\hlstd{(type)) uri} \hlkwb{<-} \hlkwd{paste0}\hlstd{(uri,}\hlstr{"/"}\hlstd{,type)}
  \hlkwa{if}\hlstd{(}\hlopt{!}\hlkwd{missing}\hlstd{(id)) uri} \hlkwb{<-} \hlkwd{paste0}\hlstd{(uri,}\hlstr{"/"}\hlstd{,id)}
  \hlstd{ua} \hlkwb{<-} \hlstd{httr}\hlopt{::}\hlkwd{user_agent}\hlstd{(}\hlstr{"https://github.com/nib-si/seekr"}\hlstd{)}
  \hlkwd{skLog}\hlstd{(}\hlstr{"skGet"}\hlstd{, uri)}
  \hlstd{fht} \hlkwb{<-} \hlkwd{system.time}\hlstd{(}
  \hlstd{resp} \hlkwb{<-} \hlstd{httr}\hlopt{::}\hlkwd{GET}\hlstd{(uri,}
         \hlkwd{add_headers}\hlstd{(}\hlkwc{Accept}\hlstd{=}\hlstr{"application/json"}\hlstd{)}
         \hlstd{, ua}
         \hlstd{)}
  \hlstd{)}
  \hlkwd{cat}\hlstd{(}\hlstr{"Status code:"}\hlstd{,resp}\hlopt{$}\hlstd{status_code,}\hlstr{"\textbackslash{}n"}\hlstd{)}

  \hlkwa{if}\hlstd{( resp}\hlopt{$}\hlstd{status_code} \hlopt{<} \hlnum{300}\hlstd{) \{}
  \hlstd{parsed} \hlkwb{<-} \hlkwd{skParse}\hlstd{(resp)}
  \hlkwa{if}\hlstd{(}\hlopt{!}\hlkwd{missing}\hlstd{(id))} \hlkwd{skSetOption}\hlstd{( type, parsed}\hlopt{$}\hlstd{id )}
  \hlkwd{skLog}\hlstd{( resp}\hlopt{$}\hlstd{status_code,} \hlkwd{round}\hlstd{(fht[}\hlstr{"elapsed"}\hlstd{],}\hlnum{2}\hlstd{), parsed}\hlopt{$}\hlstd{url)}
  \hlstd{\}} \hlkwa{else} \hlstd{\{}
  \hlstd{parsed} \hlkwb{<-} \hlstd{resp}\hlopt{$}\hlstd{status_code}
  \hlkwd{skLog}\hlstd{( resp}\hlopt{$}\hlstd{status_code,} \hlkwd{round}\hlstd{(fht[}\hlstr{"elapsed"}\hlstd{],}\hlnum{2}\hlstd{))}
  \hlstd{\}}
  \hlkwd{return}\hlstd{(parsed)}
\hlstd{\}}
\hlcom{#}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Delete component.}
\hlcom{#'}
\hlcom{#' @param type Component type (e.g. "assay").}
\hlcom{#' @param id Repository id of component.}
\hlcom{#' @param uri Repository base address (URI).}
\hlcom{#' @param ... further arguments.}
\hlcom{#' @return Deleted object (list) of class \textbackslash{}code\{seek_api\}.}
\hlcom{#' @export}
\hlcom{#' @note Parameter ... is ignored at this time.}
\hlcom{#' @note Component id in options is set to NULL.}
\hlcom{#' @keywords}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{skCreate\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' options(.sk$test)}
\hlcom{#' options("sk.myid")}
\hlcom{#' r <- skDelete("assay",options("sk.aid"))}
\hlcom{#' names(r)}
\hlcom{#' r$response$status_code}
\hlcom{#' status_code(r$response)}
\hlcom{#' r}
\hlcom{#' \}}
\hlstd{skDelete} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{type}\hlstd{,} \hlkwc{id}\hlstd{,}
                   \hlkwc{uri}\hlstd{=}\hlkwd{options}\hlstd{(}\hlstr{"sk.url"}\hlstd{),} \hlkwc{...} \hlstd{)\{}
  \hlstd{bkp} \hlkwb{<-} \hlkwd{skGet}\hlstd{(type, id)}
  \hlkwd{print}\hlstd{(bkp)}
  \hlkwa{if}\hlstd{(}\hlkwd{missing}\hlstd{(type))} \hlkwd{stop}\hlstd{(}\hlstr{'Argument "type" is missing, with no default'}\hlstd{)}
  \hlkwa{if}\hlstd{(}\hlopt{!}\hlkwd{missing}\hlstd{(type)) uri} \hlkwb{<-} \hlkwd{paste0}\hlstd{(uri,}\hlstr{"/"}\hlstd{,type)}
  \hlkwa{if}\hlstd{(}\hlopt{!}\hlkwd{missing}\hlstd{(id)) uri} \hlkwb{<-} \hlkwd{paste0}\hlstd{(uri,}\hlstr{"/"}\hlstd{,id)}
  \hlkwd{print}\hlstd{(uri)}
  \hlstd{ua} \hlkwb{<-} \hlstd{httr}\hlopt{::}\hlkwd{user_agent}\hlstd{(}\hlstr{"https://github.com/nib-si/seekr"}\hlstd{)}
  \hlkwd{skLog}\hlstd{(}\hlstr{"skDelete"}\hlstd{, uri)}
  \hlstd{fht} \hlkwb{<-} \hlkwd{system.time}\hlstd{(}
  \hlstd{resp} \hlkwb{<-} \hlstd{httr}\hlopt{::}\hlkwd{DELETE}\hlstd{(uri,}
         \hlkwd{add_headers}\hlstd{(}\hlkwc{Accept}\hlstd{=}\hlstr{"application/json"}\hlstd{)}
         \hlstd{, ua}
         \hlstd{)}
  \hlstd{)}
  \hlkwd{cat}\hlstd{(}\hlstr{"Status code: delete"}\hlstd{,resp}\hlopt{$}\hlstd{status_code,}\hlstr{"\textbackslash{}n"}\hlstd{)}

  \hlkwa{if}\hlstd{( resp}\hlopt{$}\hlstd{status_code} \hlopt{<} \hlnum{300}\hlstd{) \{}
  \hlstd{parsed} \hlkwb{<-} \hlkwd{skParse}\hlstd{(resp)}
  \hlkwa{if}\hlstd{(}\hlopt{!}\hlkwd{missing}\hlstd{(id))} \hlkwd{skSetOption}\hlstd{( type, parsed}\hlopt{$}\hlstd{id )}
  \hlkwd{skLog}\hlstd{( resp}\hlopt{$}\hlstd{status_code,} \hlkwd{round}\hlstd{(fht[}\hlstr{"elapsed"}\hlstd{],}\hlnum{2}\hlstd{), parsed}\hlopt{$}\hlstd{url)}
  \hlstd{\}} \hlkwa{else} \hlstd{\{}
  \hlstd{parsed} \hlkwb{<-} \hlstd{resp}\hlopt{$}\hlstd{status_code}
  \hlkwd{skLog}\hlstd{( resp}\hlopt{$}\hlstd{status_code,} \hlkwd{round}\hlstd{(fht[}\hlstr{"elapsed"}\hlstd{],}\hlnum{2}\hlstd{))}
  \hlstd{\}}
  \hlkwd{print}\hlstd{(}\hlkwd{skGet}\hlstd{(type,id))}
  \hlkwd{return}\hlstd{(bkp)}
\hlstd{\}}
\hlcom{#}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Get content from an *sk* object.}
\hlcom{#'}
\hlcom{#' @param r object retrieved by skGet.}
\hlcom{#' @param node name of the required element. If missing, a list with}
\hlcom{#'     all relevant objects is returned.}
\hlcom{#' @param ... further arguments.}
\hlcom{#' @return File name (string).}
\hlcom{#' @export}
\hlcom{#' @note Parameter ... is ignored at this time.}
\hlcom{#' @keywords file}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{get\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' options(.sk$test)}
\hlcom{#' options("sk.myid")}
\hlcom{#' r <- skGet("people",options("sk.myid"))}
\hlcom{#' d <- skContent(r,"attributes")}
\hlcom{#' names(d)}
\hlcom{#' d$last_name}
\hlcom{#' skContent(r)$attributes$tools}
\hlcom{#' # Get list of people}
\hlcom{#' r <- skGet("people")}
\hlcom{#' d <- skContent(r)}
\hlcom{#' length(d)}
\hlcom{#' names(d)}
\hlcom{#' names(d[[1]])}
\hlcom{#' titles <- sapply(d,function(x) x$attributes$title)}
\hlcom{#' head(titles)}
\hlcom{#' # Get FAIRDOMhub user id}
\hlcom{#' myname <- titles[1]}
\hlcom{#' myname}
\hlcom{#' d[[pmatch(myname,titles)]]}
\hlcom{#' id <- d[[pmatch(myname,titles)]]$id}
\hlcom{#' id}
\hlcom{#' \}}
\hlcom{## skContent <- function(r, node, ...)\{}
\hlcom{##   if(class(r)=="seek_api") r <- r$response}
\hlcom{##   jsn <- "application/json"}
\hlcom{##   if(missing(node)) invisible(content(r,"parsed",type=jsn)$data) else}
\hlcom{##   invisible(content(r,"parsed",type=jsn)$data[[node]])}
\hlcom{## \}}
\hlstd{skContent} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{r}\hlstd{,} \hlkwc{node}\hlstd{,} \hlkwc{...}\hlstd{)\{}
  \hlkwa{if}\hlstd{(}\hlkwd{class}\hlstd{(r)}\hlopt{==}\hlstr{"seek_api"}\hlstd{) r} \hlkwb{<-} \hlstd{r}\hlopt{$}\hlstd{content}
  \hlstd{jsn} \hlkwb{<-} \hlstr{"application/json"}
  \hlkwa{if}\hlstd{(}\hlkwd{missing}\hlstd{(node))} \hlkwd{invisible}\hlstd{(r)} \hlkwa{else}
  \hlkwd{invisible}\hlstd{(r[[node]])}
\hlstd{\}}
\hlcom{# skContents <- skContent}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Get details of component with id from an *sk* object.}
\hlcom{#'}
\hlcom{#' @param type Components name (e.g. 'people', 'projects', ...).}
\hlcom{#' @param title Character string with the identifier}
\hlcom{#'     of the component (title part).}
\hlcom{#' @return FAIRDOMhub component identifier: id, type and title.}
\hlcom{#'     If argument title is missing, a data frame with identifiers}
\hlcom{#'     for all items is returned.}
\hlcom{#' @note If item is not found, value 0 is returned as id.}
\hlcom{#' @note Touched component id is set in options.}
\hlcom{#' @export}
\hlcom{#' @keywords pisa}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{skFindTitle\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' options(.sk$test)}
\hlcom{#' id <- skFindId("people","Guest")}
\hlcom{#' id}
\hlcom{#' skFindTitle("people",id)}
\hlcom{#' # does not exist}
\hlcom{#' skFindId("people","No User")}
\hlcom{#' # List of projects}
\hlcom{#' projects <- skFindId("projects")}
\hlcom{#' head(projects)}
\hlcom{#' tail(projects)}
\hlcom{#' \}}
\hlstd{skFindId} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{type}\hlstd{,} \hlkwc{title}\hlstd{)\{}
     \hlstd{r} \hlkwb{<-} \hlkwd{skGet}\hlstd{(type)}
     \hlstd{d} \hlkwb{<-} \hlkwd{skContent}\hlstd{(r)}
     \hlstd{titles} \hlkwb{<-} \hlkwd{t}\hlstd{(}\hlkwd{sapply}\hlstd{(d,}\hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlkwd{c}\hlstd{(}\hlkwc{id}\hlstd{=x}\hlopt{$}\hlstd{id,} \hlkwc{type}\hlstd{=x}\hlopt{$}\hlstd{type,} \hlkwc{title}\hlstd{=x}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{title)))}
     \hlcom{# Get FAIRDOMhub user id}
     \hlkwa{if}\hlstd{(}\hlopt{!}\hlkwd{missing}\hlstd{(title))\{}
       \hlstd{id} \hlkwb{<-} \hlstd{d[[}\hlkwd{pmatch}\hlstd{(title,titles[,}\hlstr{"title"}\hlstd{])]]}\hlopt{$}\hlstd{id}
       \hlkwa{if}\hlstd{(}\hlkwd{is.null}\hlstd{(id)) id} \hlkwb{<-} \hlnum{0}
       \hlkwd{skSetOption}\hlstd{(type,id)}
       \hlkwd{return}\hlstd{(}\hlkwd{c}\hlstd{(}\hlkwc{id}\hlstd{=id,}\hlkwc{type}\hlstd{=type,} \hlkwc{title}\hlstd{=title))}
     \hlstd{\}} \hlkwa{else} \hlstd{\{}
     \hlkwd{return}\hlstd{(titles)}
     \hlstd{\}}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Sets seekr option according to the type.}
\hlcom{#'}
\hlcom{#' @param type Components name (e.g. 'people', 'projects', ...).}
\hlcom{#' @param id Character string with the identifier}
\hlcom{#'     of the component (id part).}
\hlcom{#' @return A list with the set option or NA if the type is not registered.}
\hlcom{#' @export}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{skFindTitle\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' skSetOption("people",111)}
\hlcom{#' skSetOption("myid", 368)}
\hlcom{#' skOptions()}
\hlcom{#' skSetOption("bla",1)}
\hlcom{#' \}}
\hlstd{skSetOption} \hlkwb{<-} \hlkwa{function}\hlstd{(} \hlkwc{type}\hlstd{,} \hlkwc{id}\hlstd{)\{}
       \hlstd{types} \hlkwb{=} \hlkwd{c}\hlstd{(}
            \hlkwc{url} \hlstd{=} \hlstr{"sk.url"}\hlstd{,}
            \hlkwc{usr} \hlstd{=} \hlstr{"sk.usr"}\hlstd{,}
            \hlkwc{pwd} \hlstd{=} \hlstr{"sk.pwd"}\hlstd{,}
            \hlkwc{myid} \hlstd{=} \hlstr{"sk.myid"}\hlstd{,}
            \hlkwc{programmes} \hlstd{=} \hlstr{"sk.prid"}\hlstd{,}
            \hlkwc{projects} \hlstd{=} \hlstr{"sk.pid"}\hlstd{,}
            \hlkwc{investigations} \hlstd{=} \hlstr{"sk.iid"}\hlstd{,}
            \hlkwc{studies} \hlstd{=} \hlstr{"sk.sid"}\hlstd{,}
            \hlkwc{assays} \hlstd{=} \hlstr{"sk.aid"}\hlstd{,}
            \hlkwc{people} \hlstd{=} \hlstr{"sk.ppid"}\hlstd{,}
            \hlkwc{institutions} \hlstd{=} \hlstr{"sk.instid"}
            \hlstd{)}
            \hlkwa{if}\hlstd{(}\hlopt{!}\hlkwd{is.na}\hlstd{(types[type])) \{} \hlkwd{names}\hlstd{(id)} \hlkwb{=} \hlstd{types[type]}
            \hlkwd{options}\hlstd{(}\hlkwd{as.list}\hlstd{(id))}
            \hlkwd{options}\hlstd{( types[type] ) \}} \hlkwa{else} \hlstd{\{}
            \hlkwd{warning}\hlstd{(}\hlstr{"No such type: "}\hlstd{, type)\}}

\hlstd{\}}
\hlkwd{skSetOption}\hlstd{(}\hlstr{"people"}\hlstd{,}\hlnum{111}\hlstd{)}
\end{alltt}
\begin{verbatim}
## $sk.ppid
## [1] 111
\end{verbatim}
\begin{alltt}
\hlkwd{skSetOption}\hlstd{(}\hlstr{"bla"}\hlstd{,}\hlnum{1}\hlstd{)}
\end{alltt}


{\ttfamily\noindent\color{warningcolor}{\#\# Warning in skSetOption("{}bla"{}, 1): No such type: bla}}\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Get details of component with id from an *sk* object.}
\hlcom{#'}
\hlcom{#' @param type Components name (e.g. 'people', 'projects', ...).}
\hlcom{#' @param id Character string with the identifier}
\hlcom{#'     of the component (id part).}
\hlcom{#' @return FAIRDOMhub component identifier: id, type and title.}
\hlcom{#'     If argument title is missing, a data frame with identifiers}
\hlcom{#'     for all items is returned. See note.}
\hlcom{#' @note If item is not found, empty string is returned as title.}
\hlcom{#' @note Touched component id is set in options.}
\hlcom{#' @export}
\hlcom{#' @keywords pisa}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{skFindTitle\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' skFindTitle("people",0)}
\hlcom{#' \}}
\hlstd{skFindTitle} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{type}\hlstd{,} \hlkwc{id}\hlstd{)\{}
     \hlstd{id} \hlkwb{<-} \hlkwd{as.vector}\hlstd{(id[}\hlnum{1}\hlstd{])}
     \hlstd{r} \hlkwb{<-} \hlkwd{skGet}\hlstd{(type, id )}
     \hlkwa{if}\hlstd{(} \hlkwd{class}\hlstd{(r)}\hlopt{==}\hlstr{"integer"} \hlopt{&&} \hlstd{r} \hlopt{>} \hlnum{300}\hlstd{) \{}
     \hlstd{title} \hlkwb{<-} \hlstr{""}
     \hlstd{\}} \hlkwa{else} \hlstd{\{}
     \hlstd{d} \hlkwb{<-} \hlkwd{skContent}\hlstd{(r,} \hlstr{"attributes"}\hlstd{)}
     \hlstd{title} \hlkwb{<-} \hlstd{d}\hlopt{$}\hlstd{title}
     \hlcom{# Set FAIRDOMhub user title}
     \hlstd{\}}
     \hlkwd{return}\hlstd{(}\hlkwd{c}\hlstd{(}\hlkwc{id}\hlstd{=id,} \hlkwc{type}\hlstd{=type,} \hlkwc{title}\hlstd{=title))}
     \hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Create *sk* skeleton.}
\hlcom{#'}
\hlcom{#' Creates *sk* object with required structure.}
\hlcom{#'}
\hlcom{#' @param type component name (e.g. 'people', 'projects', ...).}
\hlcom{#' @param meta a data frame with pISA metadata or}
\hlcom{#' a list with minimal information (Title, Description, *ToDo: add fields*).}
\hlcom{#' @return A list with the minimal information structure.}
\hlcom{#' @export}
\hlcom{#' @keywords pisa}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{skCreate\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' require(jsonlite)}
\hlcom{#' meta <- list(Title = "Test layer", Description = "Some description")}
\hlcom{#' type <- "projects"}
\hlcom{#' sp <- skSkeleton( type = type}
\hlcom{#'   , meta= meta}
\hlcom{#'   )}
\hlcom{#' str(sp)}
\hlcom{#' type = "investigations"}
\hlcom{#' si <- skSkeleton( type = type}
\hlcom{#'   , meta= meta}
\hlcom{#'   )}
\hlcom{#' str(si)}
\hlcom{#' type = "studies"}
\hlcom{#' ss <- skSkeleton( type = type}
\hlcom{#'   , meta= meta}
\hlcom{#'   )}
\hlcom{#' str(ss)}
\hlcom{#' type = "assays"}
\hlcom{#' sa <- skSkeleton( type = type}
\hlcom{#'   , meta= meta}
\hlcom{#'   )}
\hlcom{#' str(sa)}
\hlcom{#'}
\hlcom{#' type = "data_files"}
\hlcom{#' file =}
\hlcom{#' sdata <- skSkeleton( type = type}
\hlcom{#'   , meta= meta}
\hlcom{#'   )}
\hlcom{#' str(sdata)}
\hlcom{#' \}}
\hlcom{#'}
\hlstd{skSkeleton} \hlkwb{<-} \hlkwa{function} \hlstd{(}\hlkwc{type} \hlstd{=} \hlstr{"assay"}\hlstd{,} \hlkwc{meta}\hlstd{)\{}
\hlstd{sj} \hlkwb{<-} \hlkwd{switch}\hlstd{( type}
\hlstd{,} \hlkwc{projects} \hlstd{=}
\hlstr{[1803 chars quoted with ''']}
\hlstd{,} \hlkwc{investigations} \hlstd{=}
\hlstr{'\{
  "data": \{
    "type": "investigations",
    "attributes": \{
      "title": "*",
      "policy": \{
        "access": "download",
        "permissions": [
          \{
            "resource": \{
              "id": "*",
              "type": "projects"
            \},
            "access": "manage"
          \}
        ]
      \},
      "description": "*",
      "other_creators": ""
    \},
    "relationships": \{
      "projects": \{
        "data": [
          \{
            "id": "*",
            "type": "projects"
          \}
        ]
      \},
#      "publications": \{
#        "data": [
#          \{
#            "id": "",
#            "type": "publications"
#          \}
#        ]
#      \},
      "creators": \{
        "data": [
          \{
            "id": "*",
            "type": "people"
          \}
        ]
      \}
    \}
  \}
\}'}
\hlstd{,} \hlkwc{studies} \hlstd{=}
\hlstr{'\{
  "data": \{
    "type": "studies",
    "attributes": \{
      "title": "*",
      "description": "*",
      "experimentalists": "",
      "person_responsible_id": "*",
      "other_creators": "",
      "policy": \{
        "access": "download",
        "permissions": [
          \{
            "resource": \{
              "id": "*",
              "type": "projects"
            \},
            "access": "manage"
          \}
        ]
      \}
    \},
    "relationships": \{
      "investigation": \{
        "data": \{
          "id": "*",
          "type": "investigations"
        \}
      \}
##       , "publications": \{
##         "data": [
##           \{
##             "id": "",
##             "type": "publications"
##           \}
##         ]
##       \}
      , "creators": \{
        "data": [
          \{
            "id": "*",
            "type": "people"
          \}
        ]
      \}
    \}
  \}
\}'}
\hlstd{,} \hlkwc{assays} \hlstd{=}
\hlstr{[1892 chars quoted with ''']}
\hlstd{,} \hlkwc{documents} \hlstd{=}
\hlstr{[1116 chars quoted with ''']}
\hlstd{,} \hlkwc{data_files} \hlstd{=}
\hlstr{[1064 chars quoted with ''']}
\hlstd{,} \hlstr{'\{"Error":"No such type"\}'}
\hlstd{)}
\hlcom{# keep uncommented lines}
\hlstd{sx} \hlkwb{<-} \hlkwd{unlist}\hlstd{(}\hlkwd{strsplit}\hlstd{(sj,}\hlstr{"\textbackslash{}n"}\hlstd{))}
\hlstd{sx} \hlkwb{<-} \hlstd{sx[}\hlopt{!}\hlkwd{grepl}\hlstd{(}\hlstr{"^#"}\hlstd{,sx)]}
\hlstd{sj} \hlkwb{<-} \hlkwd{paste}\hlstd{(sx,}\hlkwc{collapse}\hlstd{=}\hlstr{"\textbackslash{}n"}\hlstd{)}
\hlstd{sr} \hlkwb{<-} \hlstd{jsonlite}\hlopt{::}\hlkwd{fromJSON}\hlstd{(sj,} \hlkwc{simplifyVector} \hlstd{=} \hlnum{TRUE}\hlstd{)}
\hlkwd{return}\hlstd{(sr)}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Writes a note to a log file.}
\hlcom{#'}
\hlcom{#' @param ... Objects to form a line.}
\hlcom{#' @param file Log file name.}
\hlcom{#' @param append Control append/rewrite mode.}
\hlcom{#' @return System time of invoking..}
\hlcom{#' @export}
\hlcom{#' @keywords pisa}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{skGet\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' tst <- function()\{}
\hlcom{#'   skLog("Test", "writing to logfile", file="")}
\hlcom{#'   fht <- system.time(Sys.sleep(1))}
\hlcom{#'   skLog( "Time:", round(fht["elapsed"],2))}

\hlcom{#' \}}
\hlcom{#' tst()}
\hlcom{#' rm(tst)}
\hlcom{#'}
\hlcom{#' @rdname skLog}
\hlcom{#' @export skLog}
\hlstd{skLog} \hlkwb{<-} \hlkwa{function}\hlstd{(} \hlkwc{...}\hlstd{,} \hlkwc{file}\hlstd{=}\hlstr{"FAIRDOM.log"}\hlstd{,}\hlkwc{append}\hlstd{=}\hlnum{TRUE}\hlstd{)\{}
   \hlkwd{cat}\hlstd{(}\hlkwd{paste}\hlstd{(}\hlkwd{Sys.time}\hlstd{(),...,} \hlstr{"\textbackslash{}n"}\hlstd{),} \hlkwc{file}\hlstd{=file,} \hlkwc{append}\hlstd{=append)}
   \hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Determine MIME type for file.}
\hlcom{#'}
\hlcom{#' @param file file name.}
\hlcom{#' @return MIME type string.}
\hlcom{#' @export}
\hlcom{#' @keywords pisa}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' contentType("bla.txt")}
\hlcom{#' contentType("bla.pdf")}
\hlcom{#' contentType("bla.tar.gz")}
\hlcom{#' contentType("bla.bla")}
\hlcom{#' contentType("bla")}
\hlcom{#' contentType("bla.")}
\hlcom{#'}
\hlstd{contentType} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{file}\hlstd{)\{}
      \hlstd{type} \hlkwb{<-} \hlkwd{gsub}\hlstd{(}\hlstr{"(.*)\textbackslash{}\textbackslash{}.(.*)"}\hlstd{,} \hlstr{"\textbackslash{}\textbackslash{}2"}\hlstd{,} \hlkwd{basename}\hlstd{(file))}
    \hlkwa{if} \hlstd{(type} \hlopt{==} \hlstd{file)}
        \hlstd{type} \hlkwb{<-} \hlstr{""}
  \hlkwd{switch}\hlstd{(}\hlkwd{tolower}\hlstd{(type)}
         \hlstd{,} \hlkwc{txt}  \hlstd{=} \hlstr{"text/plain"}
         \hlstd{,} \hlkwc{rnw}  \hlstd{=} \hlstr{"text/plain"}
         \hlstd{,} \hlkwc{log}  \hlstd{=} \hlstr{"text/plain"}
         \hlstd{,} \hlkwc{rmd}  \hlstd{=} \hlstr{"text/markdown"}
         \hlstd{,} \hlkwc{md}   \hlstd{=} \hlstr{"text/markdown"}
         \hlstd{,} \hlkwc{csv}  \hlstd{=} \hlstr{"text/plain"}
         \hlstd{,} \hlkwc{tsv}  \hlstd{=} \hlstr{"text/plain"}
         \hlstd{,} \hlkwc{bat}  \hlstd{=} \hlstr{"text/plain"}
         \hlstd{,} \hlkwc{htm}  \hlstd{=} \hlstr{"text/html"}
         \hlstd{,} \hlkwc{html} \hlstd{=} \hlstr{"text/html"}
         \hlstd{,} \hlkwc{pdf}  \hlstd{=} \hlstr{"application/pdf"}
         \hlstd{,} \hlkwc{doc}  \hlstd{=} \hlstr{"application/msword"}
         \hlstd{,} \hlkwc{docx} \hlstd{=} \hlstr{"application/msword"}
         \hlstd{,} \hlkwc{xls}  \hlstd{=} \hlstr{"application/excel"}
         \hlstd{,} \hlkwc{xlsx} \hlstd{=} \hlstr{"application/excel"}
         \hlstd{,} \hlkwc{tex}  \hlstd{=} \hlstr{"text/plain"}
         \hlstd{,} \hlkwc{gz}   \hlstd{=} \hlstr{"application/x-gz"}
         \hlstd{,} \hlkwc{tar}  \hlstd{=} \hlstr{"application/x-tar"}
         \hlstd{,} \hlkwc{jpg}  \hlstd{=} \hlstr{"image/jpeg"}
         \hlstd{,} \hlkwc{jpeg} \hlstd{=} \hlstr{"image/jpeg"}
         \hlstd{,} \hlkwc{png}  \hlstd{=} \hlstr{"image/png"}
         \hlstd{,} \hlkwc{tif}  \hlstd{=} \hlstr{"image/tiff"}
         \hlstd{,} \hlkwc{tiff} \hlstd{=} \hlstr{"image/tiff"}
         \hlstd{,} \hlstr{"application/octet-stream"}
         \hlstd{)}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}



\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Create pISA layer or *sk* component.}
\hlcom{#'}
\hlcom{#' @param type Component name (e.g. 'people', 'projets', ...).}
\hlcom{#' @param meta Data frame with pISA metadata or}
\hlcom{#'     a list with minimal information (Title,}
\hlcom{#'     Description, *ToDo: add fields*).}
\hlcom{#' @param class Assay class key string.}
\hlcom{#'     Possible values are 'EXP' and 'MODEL'.}
\hlcom{#' @param file File name with path, relative to layer.}
\hlcom{#' @return FAIRDOMhub created component.}
\hlcom{#' @note Upon success (status code 200) details}
\hlcom{#' of newly created component can be used. Check status code.}
\hlcom{#' @note Created component id is set in options.}
\hlcom{#' @export}
\hlcom{#' @keywords pisa}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{skGet\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' if(FALSE)}
\hlcom{#' \{}
\hlcom{#' options(.sk$test)}
\hlcom{#' options(sk.prid = 26)}
\hlcom{#' skOptions("id")}
\hlcom{#' meta= list(}
\hlcom{#'       Title=paste("Test project", Sys.time())}
\hlcom{#'     , Description="Testing upload")}
\hlcom{#' meta}
\hlcom{#' rm(sp)}
\hlcom{#'  sp <- skCreate( type = "projects"}
\hlcom{#'     , meta = meta}
\hlcom{#'     )}
\hlcom{#'     (r <- skFindId("projects",meta$Title))}
\hlcom{#'  sp}
\hlcom{#'  str(skContent(sp))}
\hlcom{#' # Call to API does not set the 'member' field}
\hlcom{#' # Add member manually in the project page on the web site:}
\hlcom{#' # /Actions/Administer project members}
\hlcom{#' #}
\hlcom{#'  options(sk.prid=26, sk.pid=sp$id)}
\hlcom{#'  skOptions("id")}
\hlcom{#'  meta= list(}
\hlcom{#'       Title=paste("Test investigation", Sys.time())}
\hlcom{#'     , Description="Testing upload")}
\hlcom{#'     meta}
\hlcom{#'     rm(si)}
\hlcom{#'  si <- skCreate( type = "investigations"}
\hlcom{#'   , meta=meta}
\hlcom{#'     )}
\hlcom{#'  si}
\hlcom{#'  skContent(si)$id}
\hlcom{#'  skFindId("investigations",meta$Title)}
\hlcom{#'  options(sk.iid=si$id)}
\hlcom{#'  skOptions("id")}
\hlcom{#' #'}
\hlcom{#'  iid=skContent(si)$id}
\hlcom{#'  options(sk.prid=26, sk.pid=sp$id, sk.iid=si$id)}
\hlcom{#'  skOptions("id")}
\hlcom{#'  ss <- skCreate( type = "studies"}
\hlcom{#'   , meta= list(}
\hlcom{#'       Title=paste("Test study", Sys.time())}
\hlcom{#'     , Description="Testing upload")}
\hlcom{#'     )}
\hlcom{#'  ss}
\hlcom{#'  skContent(ss)$id}
\hlcom{#' #'}
\hlcom{#'  options(sk.prid = 26}
\hlcom{#'        , sk.pid=skContent(sp)$id}
\hlcom{#'        , sk.iid=skContent(si)$id}
\hlcom{#'        , sk.sid=skContent(ss)$id}
\hlcom{#'        )}
\hlcom{#'  skOptions()}
\hlcom{#'  sa <- skCreate( type = "assays"}
\hlcom{#'   , meta= list(}
\hlcom{#'       Title=paste("Test assay", Sys.time())}
\hlcom{#'     , Description="Testing upload")}
\hlcom{#'     , class="EXP"}
\hlcom{#'     )}
\hlcom{#'  str(sa)}
\hlcom{#'  skContent(sa)$relationships$submitter}
\hlcom{#'  skContent(sa)$links}
\hlcom{#' \}}
\hlcom{#'}
\hlcom{#' # Type: data_file}
\hlcom{#' astring <- "_p_Demo/_I_Test/_S_Show/_A_Work-R/"}
\hlcom{#' oldwd <- setwd(system.file("extdata",astring,package="seekr"))}
\hlcom{#' oldwd}
\hlcom{#' .aname <- getLayer("A")}
\hlcom{#' .aroot <- getRoot("A")}
\hlcom{#' .ameta  <- readMeta()}
\hlcom{#'  file <- "input/README.MD"}
\hlcom{#'  options(sk.prid = 26, sk.pid=sp$id, sk.iid=si$id , sk.sid=ss$id , sk.aid=sa$id)}
\hlcom{#'  skOptions()}
\hlcom{#'  type <- "data_files"}
\hlcom{#'  type <- "documents"}
\hlcom{#'  sdat <- skCreate( type = type}
\hlcom{#'   , meta= list(}
\hlcom{#'       Title=paste("Test assay", Sys.time())}
\hlcom{#'     , Description="Testing of upload")}
\hlcom{#'   , file=file}
\hlcom{#'     )}
\hlcom{#'  #str(sdat)}
\hlcom{#'  sdat}
\hlcom{#'  skContent(sdat)$id}
\hlcom{#' if(interactive()) setwd(oldwd)}
\hlcom{#' getwd()}
\hlcom{#' res <- sdat$content}
\hlcom{#' item_link <- file.path(res$meta$base_url,res$links$self)}
\hlcom{#' if(interactive()) shell.exec(item_link)}
\hlcom{#' \}}
\hlstd{skCreate} \hlkwb{<-} \hlkwa{function} \hlstd{(}\hlkwc{type} \hlstd{=} \hlstr{"assays"}\hlstd{,} \hlkwc{meta}\hlstd{=}\hlkwd{list}\hlstd{(),} \hlkwc{class}\hlstd{=}\hlstr{"EXP"}\hlstd{,} \hlkwc{file}\hlstd{=}\hlstr{"NA.TXT"}\hlstd{)\{}
     \hlstd{myid} \hlkwb{<-} \hlkwd{as.character}\hlstd{(}\hlkwd{getOption}\hlstd{(}\hlstr{"sk.myid"}\hlstd{))}
     \hlstd{prid} \hlkwb{<-} \hlkwd{as.character}\hlstd{(}\hlkwd{getOption}\hlstd{(}\hlstr{"sk.prid"}\hlstd{))}
     \hlstd{pid} \hlkwb{<-}  \hlkwd{as.character}\hlstd{(}\hlkwd{getOption}\hlstd{(}\hlstr{"sk.pid"}\hlstd{))}
     \hlstd{iid} \hlkwb{<-}  \hlkwd{as.character}\hlstd{(}\hlkwd{getOption}\hlstd{(}\hlstr{"sk.iid"}\hlstd{))}
     \hlstd{sid} \hlkwb{<-}  \hlkwd{as.character}\hlstd{(}\hlkwd{getOption}\hlstd{(}\hlstr{"sk.sid"}\hlstd{))}
     \hlstd{aid} \hlkwb{<-}  \hlkwd{as.character}\hlstd{(}\hlkwd{getOption}\hlstd{(}\hlstr{"sk.aid"}\hlstd{))}
     \hlstd{instid} \hlkwb{<-} \hlkwd{as.character}\hlstd{(}\hlkwd{getOption}\hlstd{(}\hlstr{"sk.instid"}\hlstd{))}
     \hlkwa{if}\hlstd{(}\hlkwd{is.null}\hlstd{(instid))\{}
     \hlstd{instid} \hlkwb{<-} \hlstd{(}\hlkwd{skContent}\hlstd{(}\hlkwd{skGet}\hlstd{(}\hlstr{"people"}\hlstd{,myid))}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{institutions}\hlopt{$}\hlstd{data[[}\hlnum{1}\hlstd{]]}\hlopt{$}\hlstd{id)}
     \hlkwd{options}\hlstd{(}\hlkwc{sk.instid}\hlstd{=instid)}
     \hlstd{\}}
     \hlstd{s} \hlkwb{<-} \hlkwd{skSkeleton}\hlstd{(type, meta)}
\hlcom{# Common fileds}
     \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{title}  \hlkwb{<-}  \hlkwd{getMeta}\hlstd{(meta,}\hlstr{"Title"}\hlstd{)}
     \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{description}  \hlkwb{<-}  \hlkwd{getMeta}\hlstd{(meta,} \hlstr{"Description"}\hlstd{)}
\hlcom{# Type specific fields}
     \hlkwd{switch}\hlstd{(s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{type,}
     \hlkwc{projects} \hlstd{= \{}
       \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{members} \hlkwb{<-} \hlkwd{list}\hlstd{(}\hlkwd{list}\hlstd{(}\hlkwc{person_id} \hlstd{= myid,}
       \hlkwc{institution_id} \hlstd{= instid))}
       \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{default_policy}\hlopt{$}\hlstd{permissions}\hlopt{$}\hlstd{resource}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{myid}
       \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{programmes}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{prid}
       \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{creators}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{myid}
       \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{project_administrators}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{myid}
       \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{asset_housekeeper}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{myid}
            \hlstd{\}}
     \hlstd{,} \hlkwc{investigations} \hlstd{= \{}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{projects}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{pid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{policy}\hlopt{$}\hlstd{permissions}\hlopt{$}\hlstd{resource}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{pid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{creators}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{myid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{creators}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{type} \hlkwb{<-} \hlstr{"people"}
            \hlstd{\}}
     \hlstd{,} \hlkwc{studies} \hlstd{= \{}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{investigation}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-}\hlstd{iid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{person_responsible_id} \hlkwb{<-} \hlstd{myid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{policy}\hlopt{$}\hlstd{permissions}\hlopt{$}\hlstd{resource}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{pid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{creators}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{myid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{creators}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{type} \hlkwb{<-} \hlstr{"people"}
            \hlstd{\}}
     \hlstd{,} \hlkwc{assays} \hlstd{= \{}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{study}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-}\hlstd{sid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{person_responsible_id} \hlkwb{<-} \hlstd{myid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{policy}\hlopt{$}\hlstd{permissions}\hlopt{$}\hlstd{resource}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{pid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{creators}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{myid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{creators}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{type} \hlkwb{<-} \hlstr{"people"}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{assay_class}\hlopt{$}\hlstd{title} \hlkwb{<-} \hlstr{""}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{assay_class}\hlopt{$}\hlstd{key} \hlkwb{<-} \hlkwd{toupper}\hlstd{(class)}
\hlcom{#        s$data$attributes$assay_class$key <- "MODEL"}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{assay_class}\hlopt{$}\hlstd{description} \hlkwb{<-} \hlstr{""}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{assay_type}\hlopt{$}\hlstd{label} \hlkwb{<-} \hlstr{""}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{assay_type}\hlopt{$}\hlstd{key} \hlkwb{<-} \hlstr{""}
            \hlstd{\}}
      \hlstd{,} \hlkwc{data_files} \hlstd{= \{}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{title}  \hlkwb{<-}  \hlkwd{paste0}\hlstd{(}\hlstr{"/"}\hlstd{,file)}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{description}  \hlkwb{<-}  \hlstr{""}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{tags}  \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"data"}\hlstd{,}\hlstr{"demo"}\hlstd{)}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{content_blobs}\hlopt{$}\hlstd{original_filename} \hlkwb{<-} \hlkwd{paste0}\hlstd{(}\hlstr{"/"}\hlstd{,file)}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{content_blobs}\hlopt{$}\hlstd{content_type} \hlkwb{<-} \hlkwd{contentType}\hlstd{(file)}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{policy}\hlopt{$}\hlstd{permissions}\hlopt{$}\hlstd{resource}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{pid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{creators}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{myid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{projects}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{pid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{assays}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{aid}
      \hlstd{\}}
      \hlstd{,} \hlkwc{documents} \hlstd{= \{}
        \hlstd{document_title} \hlkwb{<-} \hlkwd{paste0}\hlstd{(}\hlstr{"/"}\hlstd{,file)}
        \hlstd{document_description} \hlkwb{<-} \hlstr{""}
        \hlstd{content_type} \hlkwb{<-} \hlkwd{contentType}\hlstd{(file)}
        \hlstd{tags} \hlkwb{<-} \hlstd{content_type}
        \hlcom{#}
        \hlstd{fpath} \hlkwb{<-} \hlkwd{file.path}\hlstd{(}\hlstr{"."}\hlstd{, file)}
        \hlcom{#}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{title} \hlkwb{<-} \hlstd{document_title}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{description} \hlkwb{<-} \hlstd{document_description}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{creators}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{myid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{creators}\hlopt{$}\hlstd{data}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{projects}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{pid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{projects}\hlopt{$}\hlstd{data}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{assays}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{aid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{relationships}\hlopt{$}\hlstd{assays}\hlopt{$}\hlstd{data}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{policy}\hlopt{$}\hlstd{permissions}\hlopt{$}\hlstd{resource}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlstd{pid}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{policy}\hlopt{$}\hlstd{permissions}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{content_blobs}\hlopt{$}\hlstd{content_type} \hlkwb{<-} \hlstd{content_type}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{content_blobs}\hlopt{$}\hlstd{original_filename} \hlkwb{<-} \hlstd{document_title}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{content_blobs}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{other_creators} \hlkwb{<-} \hlstr{""}
        \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{tags} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"pISA"}\hlstd{, tags)}
      \hlstd{\}}
     \hlstd{)}
     \hlstd{baseurl} \hlkwb{<-} \hlkwd{getOption}\hlstd{(}\hlstr{"sk.url"}\hlstd{)}
     \hlstd{uri} \hlkwb{<-} \hlstd{httr}\hlopt{::}\hlkwd{modify_url}\hlstd{(baseurl,}\hlkwc{path}\hlstd{=s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{type)}
     \hlstd{I} \hlkwb{<-} \hlstd{jsonlite}\hlopt{::}\hlkwd{toJSON}\hlstd{(s,} \hlkwc{auto_unbox}\hlstd{=}\hlnum{TRUE}\hlstd{,} \hlkwc{pretty}\hlstd{=}\hlnum{TRUE}\hlstd{)} \hlcom{#}
     \hlcom{# For testing: list JSON object}
     \hlcom{#    cat(I, "\textbackslash{}n")}
     \hlcom{#}
     \hlstd{ua} \hlkwb{<-} \hlstd{httr}\hlopt{::}\hlkwd{user_agent}\hlstd{(}\hlstr{"https://github.com/nib-si/seekr"}\hlstd{)}
     \hlkwd{skLog}\hlstd{(}\hlstr{"skCreate"}\hlstd{, uri)}
     \hlstd{fht} \hlkwb{<-} \hlkwd{system.time}\hlstd{(}
         \hlstd{resp} \hlkwb{<-} \hlstd{httr}\hlopt{::}\hlkwd{POST}\hlstd{(uri}
         \hlstd{,} \hlkwd{authenticate}\hlstd{(}
             \hlkwd{getOption}\hlstd{(}\hlstr{"sk.usr"}\hlstd{)}
           \hlstd{,} \hlkwd{getOption}\hlstd{(}\hlstr{"sk.pwd"}\hlstd{)}
           \hlstd{,} \hlkwc{type} \hlstd{=} \hlstr{"basic"}\hlstd{)}
         \hlstd{,} \hlkwc{body} \hlstd{= I}
         \hlstd{,} \hlkwc{encode}\hlstd{=}\hlstr{"json"}
         \hlstd{,} \hlkwd{accept}\hlstd{(}\hlstr{"application/json"}\hlstd{)}
         \hlstd{,} \hlkwd{content_type_json}\hlstd{()}
         \hlstd{, ua}
         \hlstd{)}
         \hlstd{)}
     \hlstd{parsed} \hlkwb{<-} \hlkwd{skParse}\hlstd{(resp)}
     \hlkwd{print}\hlstd{(resp)}
     \hlkwd{skLog}\hlstd{( resp}\hlopt{$}\hlstd{headers}\hlopt{$}\hlstd{status,} \hlkwd{round}\hlstd{(fht[}\hlstr{"elapsed"}\hlstd{],}\hlnum{2}\hlstd{), parsed}\hlopt{$}\hlstd{url)}
\hlcom{# Upload file blob}
     \hlkwa{if}\hlstd{(}\hlnum{FALSE} \hlopt{&&} \hlstd{s}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{type} \hlopt{%in%} \hlkwd{c}\hlstd{(}\hlstr{"data_files"}\hlstd{,} \hlstr{"documents"}\hlstd{))\{}
     \hlkwd{skLog}\hlstd{(}\hlstr{"Upload file:"}\hlstd{, file)}
     \hlstd{res} \hlkwb{<-} \hlstd{parsed}\hlopt{$}\hlstd{content}
     \hlstd{original_filename} \hlkwb{<-} \hlstd{res}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{content_blobs[[}\hlnum{1}\hlstd{]]}\hlopt{$}\hlstd{original_filename}
     \hlstd{blob_link} \hlkwb{<-} \hlstd{res}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{content_blobs[[}\hlnum{1}\hlstd{]]}\hlopt{$}\hlstd{link}
     \hlcom{# Fill the content blob with data}
     \hlstd{uri} \hlkwb{<-} \hlstd{blob_link}
     \hlstd{fpath} \hlkwb{<-} \hlkwd{file.path}\hlstd{(}\hlstr{"."}\hlstd{,.aroot, file)}
     \hlkwa{if}\hlstd{(}\hlkwd{file.exists}\hlstd{(fpath)) \{}
     \hlkwd{skLog}\hlstd{(}\hlstr{"skUpload"}\hlstd{,uri)}
     \hlstd{fht} \hlkwb{<-} \hlkwd{system.time}\hlstd{(}
     \hlstd{resp_blob} \hlkwb{<-} \hlstd{httr}\hlopt{::}\hlkwd{PUT}\hlstd{(uri}
         \hlstd{,} \hlkwd{authenticate}\hlstd{(}
             \hlkwd{getOption}\hlstd{(}\hlstr{"sk.usr"}\hlstd{)}
           \hlstd{,} \hlkwd{getOption}\hlstd{(}\hlstr{"sk.pwd"}\hlstd{)}
           \hlstd{,} \hlkwc{type} \hlstd{=} \hlstr{"basic"}
           \hlstd{)}
    \hlstd{,} \hlkwc{body} \hlstd{=} \hlkwd{upload_file}\hlstd{(fpath)}
    \hlstd{,} \hlkwc{encode}\hlstd{=}\hlstr{"json"}
    \hlstd{,} \hlkwd{accept}\hlstd{(}\hlstr{"*.*"}\hlstd{)}
    \hlstd{))}
    \hlstd{resp_blob} \hlkwb{<-} \hlstd{jsonlite}\hlopt{::}\hlkwd{fromJSON}\hlstd{(}\hlkwd{content}\hlstd{(resp_blob,} \hlkwc{as} \hlstd{=} \hlstr{"text"}\hlstd{))}
    \hlstd{resp_blob} \hlkwb{<-} \hlkwd{paste}\hlstd{(fpath,} \hlstr{" | File size:"}\hlstd{, resp_blob)}
    \hlstd{\}} \hlkwa{else} \hlstd{\{}
    \hlstd{resp_blob} \hlkwb{<-} \hlkwd{paste}\hlstd{(}\hlstr{"Error: File not found:"} \hlstd{,fpath)}
    \hlkwd{skLog}\hlstd{( resp_blob}\hlopt{$}\hlstd{headers}\hlopt{$}\hlstd{status}
         \hlstd{,} \hlkwd{round}\hlstd{(fht[}\hlstr{"elapsed"}\hlstd{],}\hlnum{2}\hlstd{)}
         \hlstd{, parsed}\hlopt{$}\hlstd{url)}
     \hlstd{\}}
     \hlstd{\}}
     \hlkwd{skSetOption}\hlstd{(type, parsed}\hlopt{$}\hlstd{id)}
     \hlkwd{return}\hlstd{(parsed)}
\hlstd{\}}
\hlcom{#skCreate("documents",meta,file=file)}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{#' Upload file.}
\hlcom{#'}
\hlcom{#' Upload file to a created object of type 'documents' or 'data_files'.}
\hlcom{#'}
\hlcom{#' @param object A previously created SEEK component.}
\hlcom{#'     Must be one of 'documents' or 'data_files'.}
\hlcom{#' @param file File name with path, relative to layer.}
\hlcom{#' @return FAIRDOMhub created component.}
\hlcom{#' @note Upon success (status code 200) details}
\hlcom{#' of newly created component can be used. Check status code.}
\hlcom{#' @export}
\hlcom{#' @keywords pisa}
\hlcom{#' @seealso \textbackslash{}code\{\textbackslash{}link\{skCreate\}\}}
\hlcom{#' @author Andrej Blejec \textbackslash{}email\{andrej.blejec@nib.si\}}
\hlcom{#' @examples}
\hlcom{#' \textbackslash{}dontrun\{}
\hlcom{#' file <- dir()[1]}
\hlcom{#' file}
\hlcom{#' fhd <- skCreate("documents",meta,file=file)}
\hlcom{#' fhd}
\hlcom{#' sd <- skUpload(fhd, file)}
\hlcom{#' \}}
\hlcom{#'}
\hlstd{skUpload} \hlkwb{<-} \hlkwa{function}\hlstd{(} \hlkwc{object}\hlstd{,} \hlkwc{file}\hlstd{)\{}
     \hlkwa{if}\hlstd{(object}\hlopt{$}\hlstd{content}\hlopt{$}\hlstd{type} \hlopt{%in%} \hlkwd{c}\hlstd{(}\hlstr{"data_files"}\hlstd{,} \hlstr{"documents"}\hlstd{))\{}
     \hlkwd{skLog}\hlstd{(}\hlstr{"Upload file:"}\hlstd{, file)}
     \hlstd{res} \hlkwb{<-} \hlstd{object}\hlopt{$}\hlstd{content}
     \hlstd{original_filename} \hlkwb{<-} \hlstd{res}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{content_blobs[[}\hlnum{1}\hlstd{]]}\hlopt{$}\hlstd{original_filename}
     \hlstd{blob_link} \hlkwb{<-} \hlstd{res}\hlopt{$}\hlstd{attributes}\hlopt{$}\hlstd{content_blobs[[}\hlnum{1}\hlstd{]]}\hlopt{$}\hlstd{link}
     \hlcom{# Fill the content blob with data}
     \hlstd{uri} \hlkwb{<-} \hlstd{blob_link}
     \hlstd{fpath} \hlkwb{<-} \hlkwd{file.path}\hlstd{(}\hlstr{"."}\hlstd{,file)}
     \hlkwa{if}\hlstd{(}\hlkwd{file.exists}\hlstd{(fpath)) \{}
     \hlkwd{skLog}\hlstd{(}\hlstr{"skUpload"}\hlstd{,uri)}
     \hlstd{fht}\hlkwb{=}\hlopt{-}\hlnum{1}
     \hlstd{fht} \hlkwb{<-} \hlkwd{system.time}\hlstd{(}
     \hlstd{resp} \hlkwb{<-} \hlstd{httr}\hlopt{::}\hlkwd{PUT}\hlstd{(uri}
        \hlstd{,} \hlkwd{authenticate}\hlstd{(}
             \hlkwd{getOption}\hlstd{(}\hlstr{"sk.usr"}\hlstd{)}
           \hlstd{,} \hlkwd{getOption}\hlstd{(}\hlstr{"sk.pwd"}\hlstd{)}
           \hlstd{,} \hlkwc{type} \hlstd{=} \hlstr{"basic"}
        \hlstd{)}
    \hlstd{,} \hlkwc{body} \hlstd{=} \hlkwd{upload_file}\hlstd{(fpath)}
    \hlstd{,} \hlkwc{encode}\hlstd{=}\hlstr{"json"}
    \hlstd{,} \hlkwd{accept}\hlstd{(}\hlstr{"*.*"}\hlstd{)}
    \hlstd{))}
    \hlkwd{print}\hlstd{(resp)}
    \hlstd{fs} \hlkwb{<-} \hlkwd{round}\hlstd{(}\hlkwd{as.numeric}\hlstd{(}\hlkwd{rawToChar}\hlstd{(resp}\hlopt{$}\hlstd{content))}\hlopt{/}\hlnum{1024}\hlopt{^}\hlnum{2}\hlstd{,}\hlnum{3}\hlstd{)}
    \hlstd{file_size} \hlkwb{<-} \hlkwd{paste0}\hlstd{(fpath,} \hlstr{" | "}\hlstd{, fs,}\hlstr{"MB"}\hlstd{)}
    \hlstd{\}} \hlkwa{else} \hlstd{\{}
    \hlstd{resp_blob} \hlkwb{<-} \hlkwd{paste}\hlstd{(}\hlstr{"Error: File not found:"} \hlstd{,fpath)}
    \hlstd{\}}
    \hlkwd{skLog}\hlstd{( resp}\hlopt{$}\hlstd{headers}\hlopt{$}\hlstd{status}
         \hlstd{,} \hlkwd{round}\hlstd{(fht[}\hlstr{"elapsed"}\hlstd{],}\hlnum{2}\hlstd{)}
         \hlstd{, file_size}
         \hlstd{, object}\hlopt{$}\hlstd{url)}
\hlstd{\}}
  \hlstd{resp}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}



\url{https://cran.r-project.org/web/packages/httr/vignettes/api-packages.html}

\url{https://docs.seek4science.org/tech/api/#section/Policy}

The access may be one of (in order of increasing "power"):

    no_access
    view
    download
    edit
    manage

In addition a Policy may give special access to specific People, People working at an Institution or working on a Project.

